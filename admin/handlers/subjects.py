import logging
from aiogram import Router, F
from aiogram.types import CallbackQuery, Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.filters import StateFilter

from admin.utils.common import add_subject, remove_subject, get_confirmation_kb
from common.keyboards import back_to_main_button, get_home_kb

async def log(name, role, state):
    logging.info(f"–í–´–ó–û–í: {name} | –†–û–õ–¨: {role} | –°–û–°–¢–û–Ø–ù–ò–ï: {await state.get_state()}")

router = Router()

class AdminSubjectsStates(StatesGroup):
    # –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
    enter_subject_name = State()
    confirm_add_subject = State()

    # –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞
    select_subject_to_delete = State()
    confirm_delete_subject = State()

# === –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–ê ===

@router.callback_query(F.data == "add_subject")
async def start_add_subject(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–ù–∞—á–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("start_add_subject", user_role, state)
    await callback.message.edit_text(
        text="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:",
        reply_markup=get_home_kb()
    )
    await state.set_state(AdminSubjectsStates.enter_subject_name)
    await log("start_add_subject_AFTER", user_role, state)

@router.message(StateFilter(AdminSubjectsStates.enter_subject_name))
async def process_subject_name(message: Message, state: FSMContext, user_role: str = None):
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("process_subject_name", user_role, state)
    subject_name = message.text.strip()

    # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if not subject_name:
        await message.answer(
            text="‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!\n\n"
                 "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:",
            reply_markup=get_home_kb()
        )
        return

    if len(subject_name) < 2:
        await message.answer(
            text="‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞!\n\n"
                 "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:",
            reply_markup=get_home_kb()
        )
        return

    if len(subject_name) > 100:
        await message.answer(
            text="‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤!\n\n"
                 "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:",
            reply_markup=get_home_kb()
        )
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (—Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –º–µ—à–∞—é—Ç)
    forbidden_chars = ['\n', '\r', '\t']
    if any(char in subject_name for char in forbidden_chars):
        await message.answer(
            text="‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏ —Ç–∞–±—É–ª—è—Ü–∏—é!\n\n"
                 "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:",
            reply_markup=get_home_kb()
        )
        return

    await state.update_data(subject_name=subject_name)
    await state.set_state(AdminSubjectsStates.confirm_add_subject)

    await message.answer(
        text=f"üìã –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞:\n\n"
             f"–ù–∞–∑–≤–∞–Ω–∏–µ: {subject_name}",
        reply_markup=get_confirmation_kb("add", "subject")
    )
    await log("process_subject_name_AFTER", user_role, state)

@router.callback_query(StateFilter(AdminSubjectsStates.confirm_add_subject), F.data.startswith("confirm_add_subject_"))
async def confirm_add_subject(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("confirm_add_subject", user_role, state)
    data = await state.get_data()
    subject_name = data.get("subject_name", "")

    success, error_message = await add_subject(subject_name)

    if success:
        await callback.message.edit_text(
            text=f"‚úÖ –ü—Ä–µ–¥–º–µ—Ç '{subject_name}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!",
            reply_markup=get_home_kb()
        )
    else:
        await callback.message.edit_text(
            text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ '{subject_name}'!\n\n"
                 f"–ü—Ä–∏—á–∏–Ω–∞: {error_message}",
            reply_markup=get_home_kb()
        )
    await state.clear()
    await log("confirm_add_subject_AFTER", user_role, state)

# === –£–î–ê–õ–ï–ù–ò–ï –ü–†–ï–î–ú–ï–¢–ê ===

async def get_subjects_list_kb(callback_prefix: str = "select_subject"):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø—Ä–µ–¥–º–µ—Ç–æ–≤"""
    from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
    from database import SubjectRepository

    subjects = await SubjectRepository.get_all()
    buttons = []

    for subject in subjects:
        buttons.append([
            InlineKeyboardButton(
                text=subject.name,
                callback_data=f"{callback_prefix}_{subject.id}"
            )
        ])

    buttons.append(back_to_main_button())
    return InlineKeyboardMarkup(inline_keyboard=buttons)

@router.callback_query(F.data == "remove_subject")
async def start_remove_subject(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–ù–∞—á–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("start_remove_subject", user_role, state)

    try:
        subjects_kb = await get_subjects_list_kb("delete_subject")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–º–µ—Ç—ã
        from database import SubjectRepository
        subjects = await SubjectRepository.get_all()

        if not subjects:
            await callback.message.edit_text(
                text="üìã –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø—É—Å—Ç!\n\n"
                     "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–∏.",
                reply_markup=get_home_kb()
            )
            return

        await callback.message.edit_text(
            text="–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:",
            reply_markup=subjects_kb
        )
        await state.set_state(AdminSubjectsStates.select_subject_to_delete)

    except Exception as e:
        await callback.message.edit_text(
            text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤!\n\n"
                 f"–ü—Ä–∏—á–∏–Ω–∞: {str(e)}",
            reply_markup=get_home_kb()
        )

    await log("start_remove_subject_AFTER", user_role, state)

@router.callback_query(StateFilter(AdminSubjectsStates.select_subject_to_delete), F.data.startswith("delete_subject_"))
async def select_subject_to_delete(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–í—ã–±—Ä–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"""
    await log("select_subject_to_delete", user_role, state)

    try:
        from database import SubjectRepository, CourseRepository

        subject_id = int(callback.data.replace("delete_subject_", ""))
        subject = await SubjectRepository.get_by_id(subject_id)

        if not subject:
            await callback.message.edit_text(
                text="‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!",
                reply_markup=get_home_kb()
            )
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –ø—Ä–µ–¥–º–µ—Ç –≤ –∫—É—Ä—Å–∞—Ö
        all_courses = await CourseRepository.get_all()
        linked_courses = []

        for course in all_courses:
            course_subjects = await SubjectRepository.get_by_course(course.id)
            if any(s.id == subject_id for s in course_subjects):
                linked_courses.append(course.name)

        warning_text = ""
        if linked_courses:
            courses_text = ", ".join(linked_courses)
            warning_text = f"\n‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü—Ä–µ–¥–º–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫—É—Ä—Å–∞—Ö: {courses_text}\n"

        await state.update_data(subject_to_delete=subject_id, subject_name=subject.name)
        await state.set_state(AdminSubjectsStates.confirm_delete_subject)

        await callback.message.edit_text(
            text=f"üóë –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞:\n\n"
                 f"–ù–∞–∑–≤–∞–Ω–∏–µ: {subject.name}{warning_text}\n"
                 f"‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
            reply_markup=get_confirmation_kb("delete", "subject", str(subject_id))
        )

    except ValueError as e:
        await callback.message.edit_text(
            text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ID –ø—Ä–µ–¥–º–µ—Ç–∞!\n\n"
                 f"–ü—Ä–∏—á–∏–Ω–∞: {str(e)}",
            reply_markup=get_home_kb()
        )
    except Exception as e:
        await callback.message.edit_text(
            text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞!\n\n"
                 f"–ü—Ä–∏—á–∏–Ω–∞: {str(e)}",
            reply_markup=get_home_kb()
        )

    await log("select_subject_to_delete_AFTER", user_role, state)

@router.callback_query(StateFilter(AdminSubjectsStates.confirm_delete_subject), F.data.startswith("confirm_delete_subject_"))
async def confirm_delete_subject(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("confirm_delete_subject", user_role, state)
    data = await state.get_data()
    subject_id = data.get("subject_to_delete")
    subject_name = data.get("subject_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç")

    success, error_message = await remove_subject(subject_id)

    if success:
        await callback.message.edit_text(
            text=f"‚úÖ –ü—Ä–µ–¥–º–µ—Ç '{subject_name}' —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!",
            reply_markup=get_home_kb()
        )
    else:
        await callback.message.edit_text(
            text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ '{subject_name}'!\n\n"
                 f"–ü—Ä–∏—á–∏–Ω–∞: {error_message}",
            reply_markup=get_home_kb()
        )

    await state.clear()
    await log("confirm_delete_subject_AFTER", user_role, state)

# === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–¢–ú–ï–ù–´ ===

@router.callback_query(StateFilter(AdminSubjectsStates.confirm_add_subject), F.data.startswith("cancel_add_subject"))
async def cancel_add_subject(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("cancel_add_subject", user_role, state)
    await callback.message.edit_text(
        text="‚ùå –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ",
        reply_markup=get_home_kb()
    )
    await state.clear()
    await log("cancel_add_subject_AFTER", user_role, state)

@router.callback_query(StateFilter(AdminSubjectsStates.confirm_delete_subject), F.data.startswith("cancel_delete_subject"))
async def cancel_delete_subject(callback: CallbackQuery, state: FSMContext, user_role: str = None):
    """–û—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞"""
    await log("cancel_delete_subject", user_role, state)
    await callback.message.edit_text(
        text="‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ",
        reply_markup=get_home_kb()
    )
    await state.clear()
    await log("cancel_delete_subject_AFTER", user_role, state)
